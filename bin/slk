#!/bin/bash

set -u

usage(){
  cat <<EOF
Usage:
  $0 -h
  $0 [-c CHANNEL] message

Description:
  Send a message to Slack by using Incoming Webhook.
  Webhook URL must be defined in '~/etc/.slackconfig' as following.

  piyopiyo=https://hooks.slack.com/services/XXXXXXXXX/YYYYYYYYYYYYYYYYYYYYYYYY
  
  Format:
  <id>=<url>
  * id : webhook id. you can specify message destination by id. (coming soon!)
  * url : webhook URL. Please get from https://slack.com/services/new/incoming-webhook 
  * Definition starting with the character '#' is ignored.
  
Options:
  -h help
  -c channel 
EOF
}

################################################################

option_channel=''

# options
while getopts hc: opts
do
  case $opts in
  h)
    usage
	exit 0
	;;
  c)
    readonly option_channel="$OPTARG"
	;;
  \?)
    exit 1
  esac
done
shift $((OPTIND - 1))

# requirements
readonly REQUIRED_CMDS="curl"
for cmd in $REQUIRED_CMDS
do
  if ! type $cmd >/dev/null 2>&1; then
	{
      echo "$cmd not found."
	  cat 'Requirements:'
	  for c in $REQUIRED_CMDS; do echo "  - $c"; done
	} >&2
	exit 1
  fi
done

################################################################

readonly CONFIG="$HOME/etc/.slackconfig"
readonly MESSAGE=$( [ -p /dev/stdin ] && cat - || echo "$1" )
readonly CHANNEL=${option_channel}

# Webhook URL
readonly WEBHOOK_URL=$(grep -v '^#.*' "$CONFIG" | head -n 1 | sed -e 's/^[^=]*=//')
[[ -z "$WEBHOOK_URL" ]] && {
  echo 'Webhook URL is not defined.' >&2
  exit 1;
}

# Send Message
if [ ! -z $MESSAGE ]; then
  payload=''
  # channel
  [ ! -z $CHANNEL ] && payload="${payload}\"channel\": \"$CHANNEL\","
  # text
  payload="${payload}\"text\": \"$MESSAGE\""

  curl -X POST -d "payload={${payload}}" $WEBHOOK_URL
fi


